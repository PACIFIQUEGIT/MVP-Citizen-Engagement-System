<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard - Complaints</title>
  <style>
    body { font-family: Arial; padding: 20px; max-width: 1000px; margin: auto; }
    h2, h3 { color: #333; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: left; }
    th { background: #f0f0f0; }
    select { padding: 5px; }
    input, button { padding: 8px; margin: 5px 0; }
    .success { color: green; }
    .error { color: red; }
  </style>
</head>
<body>

<!-- Login Section -->
<div id="loginSection">
  <div>
  <button onclick="window.location.href='index.html'" style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
    ‚¨Ö Home
  </button>
</div>
  <h3>Admin Login</h3>
  <input type="email" id="email" placeholder="Email" /><br>
  <input type="password" id="password" placeholder="Password" /><br>
  <button onclick="adminLogin()">Login</button>
  <p id="loginMessage"></p>
</div>

<!-- Dashboard Section -->
<div id="dashboard" style="display: none;">
  <div>
  <button onclick="window.location.href='admin.html'" style="padding: 8px 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
    üîì Logout
  </button>
  </div>
  <h2>Admin Complaint Dashboard</h2>
  <table id="complaintsTable">
    <thead>
      <tr>
        <th>Ticket ID</th>
        <th>Title</th>
        <th>Category</th>
        <th>Status</th>
        <th>Submitted</th>
        <th>Update Status</th>
        <th>Response Note</th>
        <th>Submit</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
  let token = '';

  async function adminLogin() {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();
    const msg = document.getElementById('loginMessage');

    try {
      const res = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      });

      const data = await res.json();
      if (res.ok) {
        token = data.token;
        msg.textContent = '‚úÖ Login successful.';
        msg.className = 'success';
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        fetchComplaints();
      } else {
        msg.textContent = '‚ùå ' + data.message;
        msg.className = 'error';
      }
    } catch (err) {
      msg.textContent = '‚ùå Network error.';
      msg.className = 'error';
    }
  }

  async function fetchComplaints() {
    const tbody = document.querySelector('#complaintsTable tbody');
    tbody.innerHTML = '';

    try {
      const res = await fetch('/api/complaints/all', {
        headers: { Authorization: 'Bearer ' + token }
      });

      if (!res.ok) {
        alert('Session expired or unauthorized. Please log in again.');
        location.reload();
        return;
      }

      const complaints = await res.json();
      complaints.forEach(c => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${c.ticketId}</td>
          <td>${c.title || 'N/A'}</td>
          <td>${c.category}</td>
          <td>${c.status}</td>
          <td>${new Date(c.submittedAt).toLocaleString()}</td>
          <td>
            <select onchange="updateStatus('${c.ticketId}', this.value)">
              <option value="">-- Change --</option>
              <option value="Pending">Pending</option>
              <option value="In Progress">In Progress</option>
              <option value="Resolved">Resolved</option>
            </select>
          </td><td>
            <textarea id="note-${c.ticketId}" rows="2" style="width: 100%;">${c.responseNote || ''}</textarea>
          </td>
          <td>
            <button onclick="submitResponse('${c.ticketId}')">Submit</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    } catch (err) {
      console.error('Error loading complaints:', err);
      alert('‚ùå Failed to load complaints.');
    }
  }

  async function updateStatus(ticketId, newStatus) {
  if (!newStatus) return;

  if (!token) {
    alert('‚ùå No valid session. Please log in again.');
    return;
  }

  try {
    const res = await fetch(`/api/complaints/status/${ticketId}`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`  // ‚úÖ Ensure token is attached
      },
      body: JSON.stringify({ status: newStatus })
    });

    if (res.ok) {
      alert(`‚úÖ Status updated to "${newStatus}"`);
      fetchComplaints(); // Refresh list
    } else {
      const data = await res.json();
      alert(`‚ùå Failed to update: ${data.message}`);
    }
  } catch (err) {
    alert('‚ùå Network/server error.');
    console.error(err);
  }
}

async function submitResponse(ticketId) {
    const noteTextarea = document.getElementById(`note-${ticketId}`);
    const responseNote = noteTextarea.value;

    if (!responseNote.trim()) {
      alert('‚ùå Please enter a response note before submitting.');
      return;
    }

    try {
      const res = await fetch(`/api/complaints/response/${ticketId}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ responseNote })
      });

      const data = await res.json();

      if (res.ok) {
        alert(`‚úÖ Response note submitted.`);
        fetchComplaints(); // refresh the table
      } else {
        alert(`‚ùå Failed to submit: ${data.message}`);
      }
    } catch (err) {
      console.error('Network error:', err);
      alert('‚ùå Network/server error.');
    }
  }


</script>

</body>
</html>
